<!doctype html>
<html lang="lv" data-bs-theme="auto">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <meta name="description" content="Kāds es esmu? Rakstura īpašības — optimists vai pesimists un tulkojumi latviešu ➜ angļu." />
    <title>Kāds es esmu? Rakstura īpašības</title>
    <link rel="manifest" href="manifest.json" />
    <link rel="icon" href="favicon.ico" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.13.1/font/bootstrap-icons.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <nav class="navbar navbar-expand-lg bg-body-tertiary fixed-top border-bottom">
      <div class="container">
        <a class="navbar-brand d-flex align-items-center gap-2" href="index.html">
          <i class="bi bi-translate"></i> Latvian B1
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNav" aria-controls="offcanvasNav" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasNav" aria-labelledby="offcanvasNavLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="offcanvasNavLabel">Menu</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body align-items-lg-center">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
              <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
              <li class="nav-item"><a class="nav-link" href="darbibas-vards.html">Darbības Vārds</a></li>
              <li class="nav-item"><a class="nav-link" href="conjugation-sprint.html">Conjugation Sprint</a></li>
              <li class="nav-item"><a class="nav-link" href="endings-builder.html">Endings Builder</a></li>
              <li class="nav-item"><a class="nav-link" href="passive-lab.html">Ciešamās Kārtas Laboratorija</a></li>
              <li class="nav-item"><a class="nav-link" href="travel-tracker.html">Travel Tracker</a></li>
              <li class="nav-item"><a class="nav-link" href="maini-vai-mainies.html">Maini vai mainies?</a></li>
              <li class="nav-item"><a class="nav-link" href="duty-dispatcher.html">Kas jādara kam?</a></li>
              <li class="nav-item">
                <a class="nav-link active" aria-current="page" href="character-traits.html">Rakstura īpašības</a>
              </li>
              <li class="nav-item"><a class="nav-link" href="week1.html">Week 1</a></li>
            </ul>
            <div class="d-flex gap-2">
              <button id="themeToggle" class="btn btn-outline-secondary" type="button" aria-label="Toggle color mode">
                <i class="bi bi-moon-stars-fill d-none" id="iconDark"></i>
                <i class="bi bi-sun-fill" id="iconLight"></i>
              </button>
              <a class="btn btn-primary" href="https://github.com/oerbey/Latvian_Lang_B1" target="_blank" rel="noopener">
                <i class="bi bi-github"></i> <span class="ms-1 d-none d-sm-inline">GitHub</span>
              </a>
            </div>
          </div>
        </div>
      </div>
    </nav>

    <main class="container py-4 mt-5">
      <header class="mb-4 text-center text-md-start">
        <p class="text-secondary mb-1">Rakstura īpašības • vārdu krājums</p>
        <h1 class="h4 mb-2">Kāds es esmu? Rakstura īpašības</h1>
        <p class="text-secondary mb-0">
          Trenē raksturot optimistu un pesimistu un atceries tulkojumu uz angļu valodu (EN helper). Vienā režīmā
          izvēlies “optimists” vai “pesimists”, otrā atrodi pareizo tulkojumu.
        </p>
      </header>

      <section class="card shadow-sm">
        <div class="card-body">
          <div class="d-flex flex-wrap align-items-center gap-3 mb-3">
            <div class="btn-group" role="group" aria-label="Režīma izvēle">
              <button type="button" class="btn btn-outline-primary active" id="mode-groups" disabled>Optimists vai pesimists</button>
              <button type="button" class="btn btn-outline-primary" id="mode-translate" disabled>Latviešu ➜ angļu</button>
            </div>
            <span class="badge bg-secondary-subtle text-secondary-emphasis" id="mode-label">Ielādē datus…</span>
          </div>

          <div id="question-area">
            <p class="text-muted small mb-1" id="question-progress">Jautājums 0 / 10</p>
            <h2 class="h3 mb-3" id="question-text">Ielādē datus…</h2>
            <div id="choices" class="d-grid gap-2"></div>
            <div class="alert alert-secondary mt-3" id="feedback" role="status" aria-live="polite">
              <div id="feedback-text">Izvēlies atbildi un saņem uzreiz skaidrojumu.</div>
              <div class="small text-muted" id="translation-line"></div>
            </div>
          </div>

          <div id="summary-area" class="d-none">
            <h2 class="h4 mb-2">Kopsavilkums</h2>
            <p class="mb-1" id="summary-score"></p>
            <p class="text-secondary mb-3" id="summary-verdict"></p>
            <div class="list-group" id="mistakes-list"></div>
          </div>
        </div>
        <div class="card-footer bg-transparent d-flex flex-wrap align-items-center gap-3">
          <span class="badge bg-secondary-subtle text-secondary-emphasis" id="score">Punkti: 0 / 0</span>
          <span class="badge bg-secondary-subtle text-secondary-emphasis" id="counter">Jautājums 0 / 10</span>
          <button class="btn btn-outline-secondary" id="next-btn" type="button" disabled>Nākamais jautājums</button>
          <button class="btn btn-primary ms-auto" id="restart-btn" type="button">Spēlēt vēlreiz</button>
        </div>
      </section>
    </main>

    <footer class="border-top py-4 bg-body-tertiary mt-4">
      <div class="container d-flex flex-column flex-md-row justify-content-between align-items-center gap-3">
        <span class="text-secondary">© <span id="year"></span> Latvian B1 Games</span>
        <nav class="small">
          <a class="link-secondary me-3" href="index.html">Home</a>
          <a class="link-secondary me-3" href="darbibas-vards.html">Verbs</a>
          <a class="link-secondary me-3" href="conjugation-sprint.html">Conjugation Sprint</a>
          <a class="link-secondary me-3" href="endings-builder.html">Endings Builder</a>
          <a class="link-secondary me-3" href="passive-lab.html">Ciešamās Kārtas Laboratorija</a>
          <a class="link-secondary me-3" href="travel-tracker.html">Travel Tracker</a>
          <a class="link-secondary me-3" href="maini-vai-mainies.html">Maini vai mainies?</a>
          <a class="link-secondary me-3" href="duty-dispatcher.html">Kas jādara kam?</a>
          <a class="link-secondary me-3" href="character-traits.html">Rakstura īpašības</a>
          <a class="link-secondary" href="week1.html">Week 1</a>
        </nav>
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script src="theme.js"></script>
    <script src="scripts/page-init.js" defer></script>
    <script type="module">
      const QUESTIONS_PER_ROUND = 10;
      const MODE_GROUPS = 'groups';
      const MODE_TRANSLATE = 'translate';

      const state = {
        mode: MODE_GROUPS,
        allWords: [],
        groupWords: [],
        questionPool: [],
        questionIndex: 0,
        asked: 0,
        correct: 0,
        mistakes: [],
        locked: false,
      };

      const modeButtons = {
        [MODE_GROUPS]: document.getElementById('mode-groups'),
        [MODE_TRANSLATE]: document.getElementById('mode-translate'),
      };
      document.getElementById('year').textContent = new Date().getFullYear();
      const questionText = document.getElementById('question-text');
      const questionProgress = document.getElementById('question-progress');
      const choices = document.getElementById('choices');
      const feedback = document.getElementById('feedback');
      const feedbackText = document.getElementById('feedback-text');
      const translationLine = document.getElementById('translation-line');
      const scoreBadge = document.getElementById('score');
      const counterBadge = document.getElementById('counter');
      const modeLabel = document.getElementById('mode-label');
      const nextBtn = document.getElementById('next-btn');
      const restartBtn = document.getElementById('restart-btn');
      const questionArea = document.getElementById('question-area');
      const summaryArea = document.getElementById('summary-area');
      const summaryScore = document.getElementById('summary-score');
      const summaryVerdict = document.getElementById('summary-verdict');
      const mistakesList = document.getElementById('mistakes-list');

      function shuffle(arr) {
        const copy = [...arr];
        for (let i = copy.length - 1; i > 0; i -= 1) {
          const j = Math.floor(Math.random() * (i + 1));
          [copy[i], copy[j]] = [copy[j], copy[i]];
        }
        return copy;
      }

      function parseCsv(text) {
        const lines = text.trim().split(/\r?\n/);
        const rows = [];
        lines.slice(1).forEach((line) => {
          if (!line.trim()) return;
          const parts = line.split(',');
          const [id, lv, en, group, ...rest] = parts;
          if (!id || !lv || !en || !group) return;
          rows.push({
            id: id.trim(),
            lv: lv.trim(),
            en: en.trim(),
            group: group.trim(),
            notes: rest.join(',').trim(),
          });
        });
        return rows;
      }

      function setModeBadge() {
        modeLabel.textContent = state.mode === MODE_GROUPS ? 'Optimists vai pesimists' : 'Latviešu ➜ angļu';
      }

      function setActiveModeButton(mode) {
        Object.entries(modeButtons).forEach(([key, btn]) => {
          if (!btn) return;
          if (key === mode) {
            btn.classList.add('active');
            btn.setAttribute('aria-pressed', 'true');
          } else {
            btn.classList.remove('active');
            btn.setAttribute('aria-pressed', 'false');
          }
        });
      }

      function setFeedbackNeutral() {
        feedback.className = 'alert alert-secondary mt-3';
        feedbackText.textContent = 'Izvēlies atbildi un saņem uzreiz skaidrojumu.';
        translationLine.textContent = '';
      }

      function updateScore() {
        scoreBadge.textContent = `Punkti: ${state.correct} / ${state.asked}`;
        counterBadge.textContent = `Jautājums ${Math.min(state.questionIndex + 1, QUESTIONS_PER_ROUND)} / ${QUESTIONS_PER_ROUND}`;
        questionProgress.textContent = `Jautājums ${Math.min(state.questionIndex + 1, QUESTIONS_PER_ROUND)} / ${QUESTIONS_PER_ROUND}`;
      }

      function buildQuestionPool(source) {
        if (!source.length) return [];
        const shuffled = shuffle(source);
        return shuffled.slice(0, Math.min(QUESTIONS_PER_ROUND, shuffled.length));
      }

      function pickDistractors(correctEn) {
        const pool = state.allWords.filter((item) => item.en !== correctEn).map((item) => item.en);
        const unique = [...new Set(pool)];
        return shuffle(unique).slice(0, 3);
      }

      function renderChoices(question) {
        choices.innerHTML = '';
        const optionButtons = [];
        if (state.mode === MODE_GROUPS) {
          const options = [
            { label: 'Optimists', value: 'optimists' },
            { label: 'Pesimists', value: 'pesimists' },
          ];
          options.forEach((opt) => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'btn btn-outline-primary btn-lg text-start';
            btn.dataset.value = opt.value;
            btn.textContent = opt.label;
            btn.addEventListener('click', () => handleAnswer(opt.value, btn));
            optionButtons.push(btn);
          });
        } else {
          const distractors = pickDistractors(question.en);
          const options = shuffle([question.en, ...distractors]);
          options.forEach((opt) => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'btn btn-outline-primary btn-lg text-start';
            btn.dataset.value = opt;
            btn.textContent = opt;
            btn.addEventListener('click', () => handleAnswer(opt, btn));
            optionButtons.push(btn);
          });
        }
        optionButtons.forEach((btn) => choices.appendChild(btn));
      }

      function showFeedback(isCorrect, question, selectedValue) {
        const correctGroup = question.group === 'optimists' ? 'optimistu' : 'pesimistu';
        if (isCorrect) {
          feedback.className = 'alert alert-success mt-3';
          feedbackText.textContent =
            state.mode === MODE_GROUPS
              ? `Pareizi, šī īpašība raksturo ${correctGroup}.`
              : 'Pareizi! Tu atceries tulkojumu.';
        } else {
          feedback.className = 'alert alert-danger mt-3';
          feedbackText.textContent =
            state.mode === MODE_GROUPS
              ? `Nē, tas vairāk raksturo ${correctGroup}.`
              : 'Šoreiz nepareizi. Paskaties uz pareizo tulkojumu.';
        }
        translationLine.textContent = `Tulkojums: ${question.en}`;

        const optionButtons = choices.querySelectorAll('button');
        optionButtons.forEach((btn) => {
          const value = btn.dataset.value;
          const isCorrectOption = state.mode === MODE_GROUPS ? value === question.group : value === question.en;
          btn.disabled = true;
          btn.classList.remove('btn-outline-primary');
          if (isCorrectOption) {
            btn.classList.add('btn-success');
          } else if (value === selectedValue) {
            btn.classList.add('btn-danger');
          } else {
            btn.classList.add('btn-outline-secondary');
          }
        });
      }

      function recordMistake(question, selectedValue) {
        state.mistakes.push({
          lv: question.lv,
          en: question.en,
          group: question.group,
          selected: selectedValue,
          mode: state.mode,
        });
      }

      function handleAnswer(selectedValue) {
        if (state.locked) return;
        state.locked = true;
        const question = state.questionPool[state.questionIndex];
        const isCorrect =
          state.mode === MODE_GROUPS ? selectedValue === question.group : selectedValue === question.en;
        state.asked += 1;
        if (isCorrect) {
          state.correct += 1;
        } else {
          recordMistake(question, selectedValue);
        }
        updateScore();
        showFeedback(isCorrect, question, selectedValue);
        nextBtn.disabled = false;
        nextBtn.textContent =
          state.questionIndex >= QUESTIONS_PER_ROUND - 1 || state.questionIndex >= state.questionPool.length - 1
            ? 'Kopsavilkums'
            : 'Nākamais jautājums';
      }

      function verdictText(percent) {
        if (percent >= 90) return 'Lieliski!';
        if (percent >= 60) return 'Labi, tu labi pārzini rakstura īpašības.';
        return 'Vajag vēl patrennēties.';
      }

      function formatGroup(group) {
        if (!group || group === 'neutral') return '';
        return group === 'optimists' ? 'optimists' : 'pesimists';
      }

      function showSummary() {
        questionArea.classList.add('d-none');
        summaryArea.classList.remove('d-none');
        const percent = state.asked ? Math.round((state.correct / state.asked) * 100) : 0;
        summaryScore.textContent = `Pareizi: ${state.correct} no ${state.asked} (${percent}%)`;
        summaryVerdict.textContent = verdictText(percent);
        mistakesList.innerHTML = '';
        if (!state.mistakes.length) {
          const ok = document.createElement('div');
          ok.className = 'alert alert-success mb-0';
          ok.textContent = 'Nav kļūdu — lieliski!';
          mistakesList.appendChild(ok);
        } else {
          state.mistakes.forEach((item) => {
            const groupLabel = formatGroup(item.group);
            const li = document.createElement('div');
            li.className = 'list-group-item d-flex flex-column flex-sm-row gap-1 gap-sm-2 justify-content-between align-items-sm-center';
            li.innerHTML = `
              <div>
                <strong>${item.lv}</strong> — ${item.en}
                ${groupLabel ? `<br><small class="text-muted">Grupa: ${groupLabel}</small>` : ''}
              </div>
              <span class="badge bg-light text-dark border">Tava atbilde: ${item.selected}</span>
            `;
            mistakesList.appendChild(li);
          });
        }
        nextBtn.disabled = true;
      }

      function renderQuestion() {
        if (!state.questionPool.length) {
          questionText.textContent = 'Nav pietiekamu datu. Pārbaudi CSV failu.';
          counterBadge.textContent = 'Jautājums 0 / 0';
          questionProgress.textContent = 'Jautājums 0 / 0';
          return;
        }
        state.locked = false;
        setFeedbackNeutral();
        summaryArea.classList.add('d-none');
        questionArea.classList.remove('d-none');
        const question = state.questionPool[state.questionIndex];
        questionText.textContent = question.lv;
        renderChoices(question);
        nextBtn.disabled = true;
        nextBtn.textContent = 'Nākamais jautājums';
        updateScore();
      }

      function nextStep() {
        if (summaryArea.classList.contains('d-none')) {
          if (state.questionIndex >= state.questionPool.length - 1) {
            showSummary();
          } else {
            state.questionIndex += 1;
            renderQuestion();
          }
        }
      }

      function startRound(mode) {
        state.mode = mode;
        setActiveModeButton(mode);
        setModeBadge();
        state.questionIndex = 0;
        state.asked = 0;
        state.correct = 0;
        state.mistakes = [];
        state.questionPool = buildQuestionPool(mode === MODE_GROUPS ? state.groupWords : state.allWords);
        renderQuestion();
      }

      async function loadData() {
        questionText.textContent = 'Ielādē datus…';
        setFeedbackNeutral();
        try {
          const res = await fetch('data/personality_words.csv');
          if (!res.ok) throw new Error('Neizdevās ielādēt CSV');
          const csvText = await res.text();
          const parsed = parseCsv(csvText);
          state.allWords = parsed;
          state.groupWords = parsed.filter((item) => item.group === 'optimists' || item.group === 'pesimists');
          Object.values(modeButtons).forEach((btn) => btn.removeAttribute('disabled'));
          document.getElementById('year').textContent = new Date().getFullYear();
          startRound(state.mode);
        } catch (err) {
          console.error(err);
          questionText.textContent = 'Radās problēma ar datu ielādi.';
          feedbackText.textContent = 'Pārbaudi failu data/personality_words.csv un mēģini vēlreiz.';
        }
      }

      modeButtons[MODE_GROUPS].addEventListener('click', () => {
        if (state.allWords.length) startRound(MODE_GROUPS);
      });
      modeButtons[MODE_TRANSLATE].addEventListener('click', () => {
        if (state.allWords.length) startRound(MODE_TRANSLATE);
      });
      nextBtn.addEventListener('click', nextStep);
      restartBtn.addEventListener('click', () => startRound(state.mode));

      loadData();
    </script>
  </body>
</html>
